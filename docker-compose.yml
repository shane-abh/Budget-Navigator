version: '3.8'

services:
  # Backend API Service
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: budget-navigator-api
    # REMOVED PORTS: Traefik handles traffic. We don't expose 8000 to the world directly.
    environment:
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}
    env_file:
      - .env
    volumes:
      - ./api:/app
      - api_data:/app/data
      - chroma_data:/app/chroma_db
    restart: unless-stopped
    healthcheck:
      # Changed localhost to 127.0.0.1 for better internal reliability
      test: ["CMD", "python", "-c", "import requests; requests.get('http://127.0.0.1:8000/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - web_proxy # MUST match the network Traefik is on
      - internal  # For backend-frontend communication (optional but good practice)
    labels:
      - "traefik.enable=true"
      # Router Configuration
      - "traefik.http.routers.rag-api.rule=Host(`api.budgetnavigator.shaneabh.com`)"
      - "traefik.http.routers.rag-api.entrypoints=websecure"
      - "traefik.http.routers.rag-api.tls=true"
      # MUST match the name defined in Traefik's command (we used 'myresolver' previously)
      - "traefik.http.routers.rag-api.tls.certresolver=myresolver" 
      # Service Configuration (Tell Traefik which port the container uses internally)
      - "traefik.http.services.rag-api.loadbalancer.server.port=8000"

  # Frontend UI Service
  ui:
    build:
      context: .
      dockerfile: Dockerfile.ui
      args:
        # CRITICAL CHANGE: The browser needs the PUBLIC domain, not localhost
        - VITE_API_URL=https://api.budgetnavigator.shaneabh.com
    container_name: budget-navigator-ui
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - web_proxy
      - internal
    labels:
      - "traefik.enable=true"
      # Router Configuration
      - "traefik.http.routers.budget-ui.rule=Host(`budgetnavigator.shaneabh.com`)"
      - "traefik.http.routers.budget-ui.entrypoints=websecure"
      - "traefik.http.routers.budget-ui.tls=true"
      - "traefik.http.routers.budget-ui.tls.certresolver=myresolver"
      # Service Configuration (Tell Traefik port 80 is the target)
      - "traefik.http.services.budget-ui.loadbalancer.server.port=80"

networks:
  web_proxy:
    external: true # This connects to the network created in Phase 1
  internal:
    driver: bridge

volumes:
  api_data:
    driver: local
  chroma_data:
    driver: local